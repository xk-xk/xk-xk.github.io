(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{423:function(t,s,a){"use strict";a.r(s);var n=a(25),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"资缘网主站-ssr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#资缘网主站-ssr"}},[t._v("#")]),t._v(" 资缘网主站(SSR)")]),t._v(" "),a("h2",{attrs:{id:"项目结构说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目结构说明"}},[t._v("#")]),t._v(" 项目结构说明")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("build")]),t._v(" "),a("ul",[a("li",[t._v("setup-dev-server.js")]),t._v(" "),a("li",[t._v("utils.js")]),t._v(" "),a("li",[t._v("vue-loader.conf.js")]),t._v(" "),a("li",[t._v("webpack.base.config.js")]),t._v(" "),a("li",[t._v("webpack.client.config.js  // 针对客户端（client-manifest）的webpack配置")]),t._v(" "),a("li",[t._v("webpack.server.config.js // 针对服务端（server-bundle）的webpack配置")])])]),t._v(" "),a("li",[a("p",[t._v("config")]),t._v(" "),a("ul",[a("li",[t._v("dev.env.js")]),t._v(" "),a("li",[t._v("index.js")]),t._v(" "),a("li",[t._v("prod.env.js")])])]),t._v(" "),a("li",[a("p",[t._v("src")]),t._v(" "),a("ul",[a("li",[t._v("...")])]),t._v(" "),a("ul",[a("li",[t._v("app.js // 应用实例（必须工厂模式）")]),t._v(" "),a("li",[t._v("App.vue // 应用实例模板")]),t._v(" "),a("li",[t._v("entry-client.js // 客户端入口文件")]),t._v(" "),a("li",[t._v("entry-server.js // 服务端入口文件")]),t._v(" "),a("li",[t._v("index.template.html // 静态页面模板（渲染模板）")]),t._v(" "),a("li",[t._v("store // 状态管理（必须工厂模式）")]),t._v(" "),a("li",[t._v("router // 路由管理（必须工厂模式）")])])]),t._v(" "),a("li",[a("p",[t._v("static")]),t._v(" "),a("ul",[a("li",[t._v("...")])])]),t._v(" "),a("li",[a("p",[t._v("package.json // 依赖配置，npm命令配置")])]),t._v(" "),a("li",[a("p",[t._v("server.js // node服务启动程序")])])]),t._v(" "),a("blockquote",[a("p",[t._v("备注：原SPA应用工程的入口文件main.js以及静态模板index.html都已删除，main.js的应用实例配置转至app.js")])]),t._v(" "),a("blockquote",[a("p",[t._v("main.js充当的应用入口转至entry-client.js,请注意区分并合理使用。")])]),t._v(" "),a("h2",{attrs:{id:"package-json核心依赖与组件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#package-json核心依赖与组件"}},[t._v("#")]),t._v(" package.json核心依赖与组件")]),t._v(" "),a("ul",[a("li",[t._v("compression")]),t._v(" "),a("li",[t._v("cross-env")]),t._v(" "),a("li",[t._v("es6-promise")]),t._v(" "),a("li",[t._v("express // node express")]),t._v(" "),a("li",[t._v("extract-text-webpack-plugin")]),t._v(" "),a("li",[t._v("lru-cache // 组件级缓存")]),t._v(" "),a("li",[t._v("route-cache // 路由缓存")]),t._v(" "),a("li",[t._v("serve-favicon // 处理favicon")]),t._v(" "),a("li",[t._v("vue //vue核心")]),t._v(" "),a("li",[t._v("vue-router // 路由")]),t._v(" "),a("li",[t._v("vue-server-renderer // SSR渲染核心（版本请与vue保持一致）")]),t._v(" "),a("li",[t._v("vuex // 状态管理")]),t._v(" "),a("li",[t._v("vuex-router-sync // 路由-状态同步")]),t._v(" "),a("li",[t._v("vue-client-only //核武器，专门用来处理不支持SSR的组件")])]),t._v(" "),a("h2",{attrs:{id:"app-js-特别说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#app-js-特别说明"}},[t._v("#")]),t._v(" app.js 特别说明")]),t._v(" "),a("h4",{attrs:{id:"使用工厂模式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用工厂模式"}},[t._v("#")]),t._v(" 使用工厂模式")]),t._v(" "),a("p",[t._v("app.js可视为SPA下的main.js文件，但注意这两者并不等同"),a("br"),t._v("\n可在app.js中进行与main.js类似的配置方法，但不同的是app.js提供了一个创建Vue实例的工厂函数，而非直接导出一个Vue实例")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createApp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" app "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("render")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("h")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("h")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("App"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" store "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("createAPP()将会在entry-client,entry-server中被指定使用，具体构造函数请自行阅读源代码")]),t._v(" "),a("blockquote",[a("p",[t._v("使用工厂模式是为了避免状态单例（在服务端渲染模式下，服务端需要为每一个访问者创建独立的应用实例）")])]),t._v(" "),a("h4",{attrs:{id:"状态与路由同步"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#状态与路由同步"}},[t._v("#")]),t._v(" 状态与路由同步")]),t._v(" "),a("p",[t._v("服务端渲染下，服务端与客户端需要保持路由的同步，我们使用store配合router来达到此目的")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" sync "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'vuex-router-sync'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createApp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sync")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"store-特别说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#store-特别说明"}},[t._v("#")]),t._v(" store 特别说明")]),t._v(" "),a("p",[t._v("同样以工厂模式创建store")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createStore")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vuex"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Store")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    modules"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    getters"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"使用说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用说明"}},[t._v("#")]),t._v(" 使用说明")]),t._v(" "),a("p",[t._v("由于在入口文件中已经将store注入到Vue所有的component中，因此在页面我们使用store的方式与以往相同")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("computed")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mapState")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'count'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("state")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("foo\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mounted")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("getters "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("dispatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("但是在js文件中，则无法通过直接引入以使用store")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// xxx.js")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" store "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./store/index.js'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("以上的代码执行将会报错，这是因为在SPA下index.js当前应用的store实例，而在SSR模式下index.js仅仅创建了一个工厂函数\n正确的使用方法是在函数调用处传入当前的store实例")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// xxx.js")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// import store from './store/index.js'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("store")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// xxx.vue")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" getUser "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxx.js'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  methods"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h4",{attrs:{id:"绑定到window"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#绑定到window"}},[t._v("#")]),t._v(" 绑定到window")]),t._v(" "),a("p",[t._v("上面的代码可以正常运行，但看起来似乎很麻烦，并且对于我们改造的调整量很大，但是我们必须确保调用的store/router属于当前的APP实例"),a("br"),t._v("\n又或者我们在entry-client.js里面将store,router与window进行绑定")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("app"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createdApp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("store "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" store\n  window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("router "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" router\n")])])]),a("p",[t._v("这样就能就js中这样使用")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 默认context是window")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// return window.store.state.user // 或者更直观的使用window.store")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("同样需要注意的是，由于服务端没有window对象，所以请在编写window相关的代码语句时确保不会被服务端所执行。")])]),t._v(" "),a("h4",{attrs:{id:"惰性注册"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#惰性注册"}},[t._v("#")]),t._v(" 惰性注册")]),t._v(" "),a("p",[t._v("当需要创建一个模块的多个实例，如果我们使用一个纯对象来声明模块的状态，那么这个状态对象会通过引用被共享，导致状态对象被修改时 store 或模块间数据互相污染的问题。通过工厂模式我们为每个APP实例创建了独立的store以避免这个问题，但我们仍然建议采用惰性注册(lazy-register)将这些模块分割到对应的路由chunk当中"),a("br"),t._v("\n对于大型的应用，我们可以将store拆分成多个模块，例如"),a("br")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// user.js")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// product.js")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" userModules "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./user.js'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("userModules"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("destoryed")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("unregister")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'user'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"访问特定平台api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#访问特定平台api"}},[t._v("#")]),t._v(" 访问特定平台API")]),t._v(" "),a("p",[t._v("由于服务端环境下没有window以及document，必须将这两个对象的相关API迁移到客户端下执行"),a("br"),t._v("\n或者在执行前检查运行环境")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("process"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("VUE_ENV")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("===")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'client'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("localStorage "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"ssr模式下生命周期特别说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ssr模式下生命周期特别说明"}},[t._v("#")]),t._v(" SSR模式下生命周期特别说明")]),t._v(" "),a("p",[t._v("在SSR下，Vue的两个重要生命周期钩子:beforeMounted mounted只会在客户端执行"),a("br"),t._v("\n为了避免Ajax请求在客户端与服务端重复请求，请将Ajax请求迁移到mounted钩子函数中")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// created 等钩子既能在服务端触发，也会在客户端执行，请确保当前功能的必要性合理拆分代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 例如：在SPA下一般的Ajax请求在created或者mounted中执行并不影响什么，但在SSR模式下则显得很重要")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 我们将请求移动到mounted下，让该请求只在客户端下执行，则有效节省了服务端的资源（因为对服务端来讲执行此次请求是完全没有必要的）")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 再例如对于特定平台的API若放在created钩子下，服务端执行会出错，我们也将其移动到只会在客户端执行的钩子函数下")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 并且！！！在created里面调用函数本身也是不具规范的一件事！！")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// created () {")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   this.fetchInfo(params).then(res =>{")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//     ...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   })")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   window.localStorage ... // 服务端将会报错")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   document.cookie ...  // 服务端将会报错")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   如果不得不在此处访问特定平台API，需要预先检查运行环境")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   if (process.env.VUE_ENV === 'client'){")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//      window.localStorage ... // 执行环境检查后该代码仅会在客户端执行")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//      document.cookie ...  // 执行环境检查后该代码仅会在客户端执行    ")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//   }")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// }")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// ->")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mounted")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("fetchInfo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("res")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("localStorage "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v(" \n  document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("cookie "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("server.js中加入了JSDOM，以在服务端环境中模拟window以及document等对象解决工程中大量window / document is undeafined错误\n但这并非是最佳解决方案， 日常编码中仍然要求遵守特别说明中的使用规范")])]),t._v(" "),a("h3",{attrs:{id:"style注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#style注意事项"}},[t._v("#")]),t._v(" Style注意事项")]),t._v(" "),a("p",[t._v("1，请勿画蛇添足")]),t._v(" "),a("div",{staticClass:"language-css extra-class"},[a("pre",{pre:!0,attrs:{class:"language-css"}},[a("code",[t._v("<style lang="),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v(" scoped>\n</>\n")])])]),a("p",[t._v("这将引起编译错误，因为lang指定了一个空的字符串值，请遵守以下的正确示范")]),t._v(" "),a("div",{staticClass:"language-css extra-class"},[a("pre",{pre:!0,attrs:{class:"language-css"}},[a("code",[t._v("<style lang="),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"scss"')]),t._v(" scoped>\n</>\n<style lang="),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"css"')]),t._v(" scoped>\n</>\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* 或者 */")]),t._v("\n<style scoped>\n</>\n")])])]),a("p",[t._v("无指定lang时编译器默认为\"lang='css'\"")]),t._v(" "),a("h4",{attrs:{id:"关于服务端数据预取-seo核心部分"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关于服务端数据预取-seo核心部分"}},[t._v("#")]),t._v(" 关于服务端数据预取（SEO核心部分）")]),t._v(" "),a("p",[t._v("通过将SPA改造成服务端渲染（SSR）我们的应用现在具备了做SEO的基础（爬虫可以访问到完整的html页面了）"),a("br"),t._v("\n但是此时SEO还没有完成，我们除了让爬虫抓取基础的html页面之外，通常还需要让爬虫抓取到页面的内容（比如文章详情，商品详情等）"),a("br"),t._v("\n所以我们需要 在html页面输出 之前将对应的数据在服务端获取并且渲染到html里面，因此在SSR下我们暴露了一个新的钩子：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" title "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" commodity "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./commodity'")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("asyncData")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("registerModule")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'commodity'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" commodity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" Promise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("all")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'commodity/fetchData'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("query"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\ncomputed"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  title"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("$store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("state"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("commodity"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("title\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("mounted")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("通过这样的方式，我们将asyncData预先获取的数据渲染到html里面，这样爬虫就可以得到一个具备内容的完整html了。")]),t._v(" "),a("h4",{attrs:{id:"静态资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#静态资源"}},[t._v("#")]),t._v(" 静态资源")]),t._v(" "),a("p",[t._v("template中需要动态引用静态资源的地方务必使用 require 进行动态引入"),a("br"),t._v("\n例如：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("img "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"'../../../static/images/login/mm--2@2x.png'\"")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这样将会引起资源404错误，进而引起页面404错误")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 正确的应该是：")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("img "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"require('$static/images/login/mm--2@2x.png')\"")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n")])])]),a("p",[t._v("如果是静态引用则不需要require"),a("br"),t._v("\n例如：")]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("img src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"../../../static/images/login/mm--2@2x.png"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("请注意区分使用场景并合理运用。")]),t._v(" "),a("h3",{attrs:{id:"缓存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存"}},[t._v("#")]),t._v(" 缓存")]),t._v(" "),a("h3",{attrs:{id:"jsdom"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#jsdom"}},[t._v("#")]),t._v(" JSDOM")]),t._v(" "),a("h3",{attrs:{id:"容灾"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#容灾"}},[t._v("#")]),t._v(" 容灾")]),t._v(" "),a("h3",{attrs:{id:"注意事项"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#注意事项"}},[t._v("#")]),t._v(" 注意事项")]),t._v(" "),a("ol",[a("li",[t._v("通过服务端预取的数据接口请不要有登录权限要求，一方面是实现这样的效果难度很大，并且再SEO需求之下这是一个自相矛盾的实现"),a("br"),t._v("\n毕竟爬虫可不会自己登录之后再来爬取我们的网页内容。")]),t._v(" "),a("li",[t._v("由于asyncData只存在于路由界面，这意味着组件无法通过asyncData来预取数据（组件的内容将不会被SEO）如果要对组件内容进行SEO请在"),a("br"),t._v("\n路由页面asyncData下获取到全部数据并通过props传递到子组件中进行渲染。")])]),t._v(" "),a("h3",{attrs:{id:"疑难杂症"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#疑难杂症"}},[t._v("#")]),t._v(" 疑难杂症")]),t._v(" "),a("p",[t._v("🐛 Error: Not implemented: window.scrollTo undefined\n上辈子被这个报错气死掉（虽然不是什么会导致程序终止的Bug，但每次都报错看着非常烦）"),a("br"),t._v("\n原因在于SSR下不支持vue-router的scrollBehavior行为，注释掉即可。"),a("br"),t._v("\n非要用怎么办？"),a("br"),t._v("\n目前暂时无解，官方也没有给出这个问题的回答或者解决办法。"),a("br"),t._v("\n如果你有什么好的解决办法， please fix me 😕")]),t._v(" "),a("p",[t._v("🐛 404 Page Not Found\n注解：通常由于各类严重的代码/逻辑错误导致Node.js server运行错误，常见于用户刷新页面后404，再次刷新正常，以此反复。。\n影响程度： 灾难性后果，导致应用程序无法正常使用。\n解决办法： 严格对待自己敲下的每一行代码并对其反复调试和验证，对于某些情况下使用热重载调试并不能得到准确的验证结果，需要\n重新执行npm run serve编译运行。\n"),a("code",[t._v("[Vue warn]: The client-side rendered virtual DOM tree is not matching server-rendered content. This is likely caused by incorrect HTML markup, for example nesting block-level elements inside <p>, or missing <tbody>. Bailing hydration and performing full client-side render.")]),t._v("\n注解：由于我们使用的是SSR混合模式（服务端渲染输出html页面后，客户端进行挂载激活，这样可避免数据重复获取，加快速度） 当出现此报错时说明客户端的DOM树与服务端渲染的内容不一致，导致混合失败，程序将自动进行客户端完全渲染。典型的症状是，在本地开发环境下具有检测双端节点一致性的功能，混合失败情况下页面仍可正常运行（自动进行客户端完全渲染） 但在生产环境下，检测双端节点一致性回大量损耗服务器性能，所以vue-server-render在生产模式下是关闭的，这将导致客户端并没有重新渲染服务端输出的错误HTML，导致页面无法正常使用。")]),t._v(" "),a("p",[t._v("所以当控制台抛出此错误时一定要重视，不能因为在开发环境下运行正常就认定为可发布生产！！")]),t._v(" "),a("ol",[a("li",[t._v("HTML代码编写不规范，导致出现无效的HTML。")]),t._v(" "),a("li",[t._v("HTML中用到了某些v-if等条件控制，在特定的情况下导致两端渲染不匹配而引起。\n影响程度： 灾难性后果，导致控制台输出异常警告，在生产模式下页面无法正常运行，进而大概率抛出404页面。\n解决办法： 严格遵守HTML标签语法标准和优秀的编码习惯（这是重点），尽量避免使用v-if（v-if为false时将无对应DOM节点）,相关需求请用v-show进行代替。")]),t._v(" "),a("li",[t._v("Promise函数必须要调用到resolve和reject")])]),t._v(" "),a("p",[t._v("问题延伸： 出现这个错误一般服务端部分渲染已经出现了问题，此情况在开发模式可能无法察觉，需要打包之后使用生产模式才能看到服务端的具体报错信息"),a("br"),t._v("\n案例： http://mirror.relaysogo.com/productMatch/result下出现如下错误: "),a("br")]),t._v(" "),a("blockquote",[a("p",[t._v("DOMException: Failed to execute 'appendChild' on 'Node': This node type does not support this method."),a("br"),t._v("\n终极解决办法： 假设经过排查、代码优化之后仍然出现这个问题，请使用"),a("code",[t._v("<client-only></client-only>")]),t._v("进行包裹，这一来范围内组件仅会在客户端进行渲染。")])]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("client"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("only"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("shit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("what the fuck"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("shit"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("client"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("only"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("template"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("如此一来，"),a("code",[t._v("<shit>")]),t._v("仅会在客户端下进行渲染，不会在服务端造成灾难性后果。\nasyncData 接口代理问题")]),t._v(" "),a("ol",[a("li",[t._v("在本地开发模式下，通过node http-proxy-middleware中间件进行代理转发，可以实现客户端请求（ajax）与服务端请求（server pre-fetch）所需要的接口代理。然而发布到生产环境时服务端请求仅在首屏渲染时有效，其余任何需要asyncData钩子进行数据预取的场景均为导致跨域问题。"),a("br"),t._v("\n具体问题的产生处在entry-client关于router hook for handling asyncData处。深究原因如下："),a("br"),t._v("\n（1） 首屏渲染时asyncData由服务端触发，node server进行数据预取，不存在跨域问题，所以首屏渲染数据渲染正常。\n（2） 路由变化时asyncData由客户端触发，浏览器进行数据预取，http-proxy-middleware 此刻不生效进而导致发生接口跨域问题。"),a("br"),t._v("\n至于为何针对asyncData的接口请求代理失败的原因目前无解，网上均无相关资料。"),a("br"),t._v("\n不过既然问题是接口跨域，那么问题的解决办法有两种：\n首先此处跨域问题是由于POST复杂请求没有通过后台请求预检（options）")]),t._v(" "),a("li",[t._v("服务端配置CORS策略，允许所有/目标作用域通过。")]),t._v(" "),a("li",[t._v("使用代理进行接口转发。\n上面我们使用了 node http-proxy-middleware中间件并不能解决所有场景下的接口转发问题， 经过一番折腾最后选择用nginx"),a("br"),t._v("\n具体的配置过程参考下方详细描述（开发模式下模拟生产环境）。")])]),t._v(" "),a("h4",{attrs:{id:"列举的业务功能重构部分"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#列举的业务功能重构部分"}},[t._v("#")]),t._v(" 列举的业务功能重构部分")]),t._v(" "),a("ol",[a("li",[t._v("关于Vue.prototype.isClick"),a("br"),t._v("\n此部分用于限制用户动作的权限控制逻辑进行了如下更改：")])]),t._v(" "),a("div",{staticClass:"language-javascript extra-class"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// entry-client.js")]),t._v("\n  router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("onReady")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("currentRoute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Add router hook for handling asyncData.")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Doing it after initial route is resolved so that we don't double-fetch")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// the data that we already have. Using router.beforeResolve() so that all")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// async components are resolved.")]),t._v("\n  router"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("beforeResolve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 每次路由resolve之前检查可操作权限，每次路由变化都会检查一次用户登录状态")]),t._v("\n    store"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("dispatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'checkOperationPerms'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 省略其余无关代码....")]),t._v("\n     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// store/modules/user.js")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("checkOperationPerms")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" commit"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" rootState "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("rootState"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("token"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isClick "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Vue")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("prototype"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("isClick "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("经测试，该功能目前运行较为稳定。")])])}),[],!1,null,null,null);s.default=e.exports}}]);